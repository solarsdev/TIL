# 테라폼 HCL 기초 문법

## 파일과 디렉토리

### 개요

- 테라폼 언어에서 코드는 평문으로 저장되며 .tf 확장자를 가짐 (JSON기반의 언어도 지원하는데, 이 경우 .tf.json) 통상적으로 .tf 확장자를 사용하고 HCL을 권장함
- 테라폼 코드가 들어있는 문서를 설정 파일이라고 부름

### 파일 인코딩

- 파일은 utf-8 인코딩으로 작성해야 하며, 개행에 관해서는 유닉스, 윈도우 개행을 둘 다 지원하지만 통상적으로 유닉스 개행문자를 사용하는것이 권장됨

### 모듈과 디렉토리

- 모듈은 .tf 또는 .tf.json 파일이 모여있는 디렉토리 자체를 의미
- 테라폼 모듈은 디렉토리 내의 설정 파일들에서 유효하며, 중첩된 디렉토리들은 완전히 별개의 모듈로 취급됨, 따라서 자동으로 읽어들일 수 없음
- 테라폼에서 수행하는 init/plan/apply는 명령어가 수행되는 디렉토리에서 .tf 파일을 찾고, 서브 디렉토리는 무시됨
- 전체 디렉토리의 .tf 파일들은 결국 하나로 합쳐져 한개의 문서로 취급됨, 따라서 파일을 여러개로 나누어 작성해도 결국 처리는 전체에 대해서 동일하게 수행하는 것과 같음
- 테라폼 파일 안에서 다른 모듈을 불러서 수행할 수 있는데, 이 자식 모듈(호출되는 쪽)은 다양한 소스로부터 가져올 수 있음

### 루트 모듈

- 테라폼은 항상 하나의 루트 모듈로부터 수행됨 (모듈의 tf 문서 묶음)
- 테라폼 CLI에서 루트 모듈은 terraform 명령어를 수행한 그 디렉토리가 됨
- 테라폼 클라우드 및 엔터프라이즈에서 루트 모듈은 기본적으로는 최상위 디렉토리지만, 원하는 경우 시작점을 변경할 수 있음

### 파일 덮어쓰기

- 테라폼에서는 같은 디렉토리 내의 .tf 와 .tf.json 파일을 하나의 뭉치로 실행하며, 같은 디렉토리 내의 별개의 .tf 파일이라고 할 지라도 동일한 문서로 통합되어 리소스의 중복 선언 등은 에러가 됨
- 간혹, 기존의 정의 파일을 건드리기 힘든 경우, 새롭게 파일을 정의하여 덮어쓰기로 작업하는 것이 선호되는 경우가 발생할 수 있는데, 이를 위해 override 기능을 제공함
- 이러한 경우에는 \_override.tf 또는 \_override.tf.json 등으로 이름을 지정하면 덮어쓰기를 할 수 있음
- 테라폼은 일단 수행시 이러한 오버라이드 파일을 스킵하고, 실행의 마지막에 기존 리소스를 덮어쓰기 하며 최종 작업을 진행함
- 오버라이드 파일을 특별한 경우에만 활용하는 것이 좋음, 또한 작업자에게 오버라이드 파일에서 어떤 것들을 재정의 하는지 명시하는 것이 좋음

```bash
# example.tf
resource "aws_instance" "web" {
  instance_type = "t2.micro"
  ami           = "ami-408c7f28"
}

# override.tf
resource "aws_instance" "web" {
  ami = "foo"
}

# actual terraform works with
resource "aws_instance" "web" {
  instance_type = "t2.micro"
  ami           = "foo"
}
```

## 문법

- 테라폼의 문법은 HCL이라고 불리는 정형화된 방식이 있음
- HCL을 이용해 다른 어플리케이션에서 제공하는 리소스 및 데이터를 이용 가능

### 인자와 블럭

```bash
# 인자의 경우 다음과 같이 명명됨 (image_id에 abc123을 대입)
image_id = "abc123"
```

- 인자의 경우 값을 입력하는 것도 되지만, 값의 연산을 통한 결과를 입력하는것도 가능함
- 블럭은 여러개의 인자를 묶는 방법인데 중괄호로 인자를 감싸게 됨
- 블럭은 하위 여러개의 블럭을 포함할 수 있음
- 탑 레벨 블럭의 경우 정해진 문법에 따라 정의됨 (resource, output, variable …)

### 구별자

- 인자, 블럭 등의 이름이 여러 단어로 이루어질 경우 구별자를 넣을 수 있음
- 구별자는 특정 영어 글자, 숫자, 밑줄, 하이픈 등으로 이루어질 수 있고 이름의 처음에 숫자는 금지됨
- 엄밀하게 정의하면 유니코드 구별자에 특별히 하이픈을 추가한 형태

### 주석

- 쉘에서 쓰는 #, C와 같은 언어에서 사용하는 //, /\*\*/ 등을 지원
- 내부적으로는 #을 주석으로 사용하고 문법상 처리로 //를 #으로 변경하게 됨 /\*\*/의 경우 전부 앞에 #을 붙임
