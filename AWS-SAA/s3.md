# S3

## S3 Overview

- Amazon S3는 다양한 사례가 이미 존재하는 AWS내에서도 핵심 서비스 중 하나
- “무한정 확장하는 스토리지”로 설명하고 있음

## S3 사용사례

- 백업 및 저장소
- DR용 데이터 보관
- 아카이빙
- 하이브리드 클라우드 저장소
- 어플리케이션 호스팅
- 미디어 호스팅
- 데이터 레이크 빅데이터 분석
- 소프트웨어 배포
- 정적 웹사이트

### 실사례

- 나스닥
  - 7년간의 데이터를 S3 글래시어에 보관중
  - 글래시어는 S3의 아카이빙 스토리지
- 시스코
  - 시스코는 비지니스 인사이트를 얻기 위해 데이터 분석용으로 S3에 저장된 데이터를 이용

## S3 개념

### 버킷

- Amazon S3는 파일을 오브젝트라 명명하고 이를 버킷(디렉토리)에 저장
- 버킷은 글로벌하게 유니크한 이름이어야 함
- 버킷은 리전 단위로 관리/만들어짐
  - 글로벌하게 이름관리 하기 때문에 글로벌 서비스 같지만 실질적으로 데이터는 리전단위로 관리됨
- 버킷 이름 명명 규칙
  - 대문자 불가, 언더라인 불가
  - 3~63 글자
  - 아이피를 나타내선 안됨
  - 소문자 영숫자로 시작해야 함
  - xn—으로 시작해서는 안됨
  - -s3alias로 끝나선 안됨

### 오브젝트

- 오브젝트는 파일이고 키와 값으로 구성됨
- 키는 FULL PATH가 됨
  - s3://my-bucket/my_file.txt
  - s3://my-bucket/my_folder/another_folder/my_file.txt
- 키는 prefix와 object_name으로 구성됨
  - s3://my-bucket/my_folder/another_folder/my_file.txt
- 디렉토리의 개념이 엄밀하게는 없음
  - 디렉토리의 모든 주소가 키의 이름 (/가 포함된 긴 문자열)
- 오브젝트의 값은 최대 5TiB (5000GiB)
- 5GiB보다 큰 파일을 업로드하려면 멀티파트업로드 라는 기능을 이용해야 함
- 메타데이터
  - 텍스트로 된 키/값의 쌍으로 파일의 정보를 담고 있음
- 태그
  - 유니코드의 키/값의 쌍으로 최대 10개 지정가능
  - 보안과 라이프사이클 관리에 도움이 됨
- 버전 ID
  - 파일 버저닝이 켜져 있을 경우에 파일마다 버전관리를 위한 식별자로 사용됨

### 보안

- User-Based
  - IAM 정책 → 특정 유저의 IAM 권한 설정으로 API의 접근권한을 분류 가능
- Resource-Based
  - 버킷 정책
    - S3 콘솔에서 적용되는 전체 버킷 설정 (다른 계정에서 접근 가능하도록 설정 가능)
  - Object ACL
    - 버킷 정책과는 별도로 좀 더 세세한 부분(오브젝트단위)로 추가적인 컨트롤이 요구될 때
  - Bucket ACL
    - 자주 사용되지는 않음
- IAM 정책이 S3오브젝트에 미치는 영향
  - IAM 권한을 가진 유저 또는 리소스 정책에서 허용 설정이 되어 있는 리소스는 접근 가능
  - 명시적 거부가 설정되어 있지 않은 리소스 (명시적 거부가 설정되면 어떤 권한도 거부됨)
- 암호화
  - S3는 암호화 키를 이용해 오브젝트 암호화 가능

## Bucket Policy

- JSON 기반 정책
  - Resources → 버킷과 오브젝트
  - Effect → Allow / Deny
  - Actions → 접근제어할 API 목록
  - Principal → 계정 또는 정책을 적용할 유저
- 버킷 정책을 사용하는 타이밍
  - 버킷의 퍼블릭 엑세스를 허용하고 싶을 때
    ![images/s3/1.png](images/s3/1.png)
  - 오브젝트 업로드 시 암호화를 강제하고 싶을 때
  - 다른 계정의 유저에게 권한을 부여 할 때 (크로스 계정)
    ![images/s3/2.png](images/s3/2.png)
  - IAM 권한을 가진 유저 혹은 IAM 역할을 가진 EC2 인스턴스
    ![images/s3/3.png](images/s3/3.png)
    ![images/s3/4.png](images/s3/4.png)

## 버킷 퍼블릭 엑세스 설정

![images/s3/5.png](images/s3/5.png)

- AWS에서는 S3에 대한 공개설정을 버킷단위로 설정하는 부분이 추가적으로 존재
- 버킷 정책에서 퍼블릭 엑세스를 허용한다고 하더라도, 이 설정을 사용하면 공개를 막을 수 있음
- 계정단위로 설정하는 옵션도 지원

## S3 Static Website Hosting

- S3에서는 인터넷 퍼블릭 엑세스를 허용하는 것으로 정적 웹사이트 호스팅이 가능
- 웹사이트 URL은 리전에 따라 조금 다르게 설정됨
  - http://bucket-name.s3-website-aws-region.amazonaws.com
  - http://bucket-name.s3-website.aws.region.amazonaws.com
- 403 에러가 발생한다면 버킷 정책을 확인하여 퍼블릭 엑세스 허용 권한을 다시한번 점검

## Versioning

- S3에서 파일의 버전관리를 설정할 수 있음
- 버킷 단위로 설정 가능
- 같은 키로 파일이 덮어쓰기 되면 버전ID가 부여되어 기록됨
- 버전관리는 기본적으로 설정하는 것이 권장됨
  - 실수로 파일을 삭제하는 것을 방지 (버전 복구 기능)
  - 전 버전으로 되돌리기 가능
- 참고
  - 버전 관리 기능이 활성화 되기 전에 업로드 된 파일의 버전은 null
  - 버전 관리 기능을 비활성화 하더라도 직전까지 생성되었던 버전은 유지됨

![images/s3/6.png](images/s3/6.png)

## Replication (CRR & SRR)

- 버전관리 기능이 활성화 된 원본 및 목적지 S3 버킷 필요
- CRR (Cross Region Replication)
  - DR 및 컴플라이언스
  - 지연속도 감소 목적 (유저가 다른 리전에서 접속하는 경우)
  - 다른 계정으로의 복제
- SRR (Same Region Replication)
  - 로그 보존
  - 프로덕션과 테스트 환경과의 실시간 복제
- AWS의 다른 계정의 버킷으로 복제 가능
- 복제 작업은 비동기로 이루어짐
- 적절한 IAM 권한이 필요 (원본에 대한 읽기, 목적지에 대한 쓰기)

### 복제에서 알아두어야 할 내용

- 복제를 활성화 한 뒤에 생성된 새로운 오브젝트에 한해 복제가 이루어짐
- 옵션으로 기존 항목을 복사하는 S3 배치 복제라는 기능이 있음
  - 기존의 오브젝트들과 실패한 복제를 다시 복제하는 기능
- 삭제를 복제하기
  - 삭제 마커를 복제할 수 있음 (옵션)
  - 버전ID를 지정하여 영구적으로 삭제하는 작업은 복제되지 않음 (악용 방지)
- 복제의 체이닝은 일어나지 않음
  - 예를 들어 버킷1을 버킷2에 복제, 버킷2를 버킷3에 복제하는 설정을 했다고 가정했을때, 버킷1에서의 변화를 버킷2가 복제하지만, 해당 작업이 버킷 3에게까지 복제되지는 않음

## Storage Classes

- Standard - General Purpose
- Standard-Infrequent Access (IA)
- One Zone-Infrequent Access (One Zone IA)
- Glacier Instant Retrieval
- Glacier Flexible Retrieval
- Glacier Deep Archive
- Intelligent Tiering

## Durability and Availability

- Durability 내구성
  - 다중 AZ에 구성된 오브젝트의 내구성 11.9 (99.999999999%)
  - 이 수치는 예를 들면 10,000,000 개의 오브젝트를 저장했다고 했을 때, 평균적으로 10,000년에 하나의 파일이 소실될 수 있음을 나타냄
  - 모든 스토리지 클래스에서 내구성은 동일
- Availability 가용성
  - 얼마나 서비스가 중단없이 지속될 수 있는지에 대한 지표
  - 스토리지 클래스에 따라 다름
  - Standard의 경우 99.99%의 가용성 (1년에 53분을 이용하지 못할 수 있음)

## S3 Standard

- 99.99% 가용성
- 자주 사용되는 데이터
- 저지연 및 높은 처리량
- 동시 2개의 데이터센터 장애에도 유지 가능
- 사용 사례
  - 빅데이터 분석
  - 모바일 및 게이밍 어플리케이션
  - 컨텐츠 배포

## S3 Infrequent Access

- 자주 사용되지 않는 데이터
- 저장에는 비용이 저렴해지지만, 데이터를 사용할때 비용이 발생 (원래는 발생 안함)
  - 따라서 엑세스가 적은 데이터 타입에 유용
- Standard-Infrequent Access (Standard IA)
  - 99.9% 가용성
  - 사례 → DR, 백업 등
- One Zone-Infrequent Access (One Zone IA)
  - 단일 AZ에 저장되는 IA로 데이터센터 장애시 사용 불가
  - 99.5% 가용성
  - 사례 → 두번째 백업 카피

## Glacier Storage Classes

- 저비용의 보관으로 아카이빙/백업 달성
- 요금 체계
  - 저장에는 매우 저렴한 데이터 비용
  - 데이터를 꺼내 올때 추가과금이 발생
- Instant Retrieval
  - 데이터를 꺼내올 때 대기시간이 매우 짧음 (분기에 한번정도 엑세스 하는데 적합)
  - 최소 저장 기간이 90일 (즉, 90일 내에는 데이터를 꺼내올 수 없음)
- Flexible Retrieval
  - Expedited (1~5분 대기), Standard (3 to 5시간 대기), Bulk (5 to 12시간 대기)
  - 최소 저장 기간이 90일
- Deep Archive
  - Standard (12시간 대기), Bulk (48시간 대기)
  - 최소 저장 기간이 180일

## Intelligent-Tiering

- 일부 월당 모니터링 및 티어링 과금이 발생
- S3에서 자동으로 파일의 엑세스 빈도를 체크하여 티어를 이동
- 꺼내 올 때 과금 없음
- Frequent Access Tier (자동)
  - 기본 티어
- Infrequent Access tier (자동)
  - 30일간 엑세스가 없을 경우
- Archive Instant Access tier (자동)
  - 90일간 엑세스가 없을 경우
- Archive Access tier (옵션)
  - 90~700일간 설정으로 선택 가능
- Deep Archive Access tier (옵션)
  - 180일~700일간의 설정으로 선택 가능

## 스토리지 클래스 이동

- 오브젝트의 스토지 클래스를 전환하는 것은 가능
- 자주 사용되지 않는 오브젝트가 있다면 Standard IA로 전환
- 자주 사용하지 않고 데이터를 필요로할 때 즉시 사용할 필요가 없다면 더 저렴한 글래시어나 딥아카이브를 이용 가능
- 수동으로 오브젝트의 스토리지 클래스를 변경할 수도 있지만, 라이프사이클 매니저로 자동화 할 수 있음

![images/s3/7.png](images/s3/7.png)

## Lifecycle Rules

- Transition (변환)
  - 오브젝트의 스토리지 클래스를 변경
    - 60일 이후에는 Standard IA로 변경한다거나
    - 6개월 뒤에는 글래시어로 아카이빙을 위해 이동한다거나
- Expiration (만료)
  - 오브젝트를 일정 기간 후에 삭제 또는 만료
    - 엑세스 로그를 365일 이후에 삭제
    - 버전관리가 설정되어 있을 경우 일정 기간 후에 오래된 버전을 삭제
    - 오래된 멀티파트 업로드 실패분을 삭제
- 룰은 프리픽스 형태로 타겟지정을 할 수 있음
  - s3://mybucket/mp3/\*
- 룰은 태그를 타겟으로 지정할 수 있음
  - Department: Finance

## Storage Class Analysis

- 오브젝트의 적당한 클래스를 정하는데 도움이 됨
- Standard나 Standard IA 클래스에 적용가능
  - One-Zone IA나 글래시어에는 적용 불가
- 데일리 업데이트
- 24~48시간의 처음 분석시간이 필요
- 라이프사이클 룰을 사용중이라면 강화하는데, 사용하지 않는다면 도입하는데 충분한 도움이 됨

![images/s3/8.png](images/s3/8.png)
