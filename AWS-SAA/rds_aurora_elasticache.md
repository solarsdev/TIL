# AWS RDS Aurora ElastiCache

## AWS RDS 개요

- RDS는 Relational Database Service의 약어
- AWS에 의해 유지보수되는 데이터베이스로 SQL에 의해 동적쿼리를 사용할 수 있는 DB
- AWS에서는 다음 RDMBS를 제공
  - Postgres
  - MySQL
  - MariaDB
  - Oracle
  - Microsoft SQL Server
  - Aurora (AWS가 최적화한 데이터베이스)

## RDS가 EC2에 설치된 DB보다 더 나은 점

- RDS가 관리형 서비스라는 것에서 오는 장점들
  - DB 관련 리소스 관리, OS 패치 등
  - 지속적인 백업을 통한 원하는 시점으로의 복구
  - 모니터링 가능한 대시보드 제공
  - 읽기 속도 증가를 위한 읽기 복제본 제공
  - DR을 위한 다중 AZ 설치
  - 업그레이드를 위한 유지보수 시간대 제공
  - 확장성 (수직, 수평 둘 다 제공)
  - EBS 볼륨으로 구성 (gp2 또는 io1)
- 단점
  - 백엔드 EC2에 직접 접근할 수 없음

## RDS 용량 자동 확장

- 필요한 타이밍에 RDS는 용량을 자동으로 확장시킴
- 직접 데이터베이스 용량조절을 위해 신경쓸 필요가 없음
- 최대 자동으로 확장 가능한 용량을 설정할수 있으므로 그만큼만 대응 가능
- 자동 확장은 다음 기준으로 발생
  - 물리적인 용량이 10% 이하로 남았을 경우
  - 낮은 스토리지 조건이 5분이상 지속될 때
  - 마지막 스토리지 수정 이후 최소 6시간 경과
- 확장되는 용량의 결정방식
  - 5GiB
  - 현재 용량의 10%
  - 앞으로 7시간의 스토리지 증가 예측 지표에 따른 용량
  - 상기 3개 옵션중 큰 용량으로 진행됨

## RDS 읽기복제본 (읽기 분산을 위해)

- 최대 5개의 읽기 복제본 생성 가능
- 같은 AZ 혹은 AZ의 분산, 리전의 분산도 가능
- 복제는 비동기적으로, 따라서 결과적 일관성에 의해 동기화 됨
- 읽기 복제본은 개별적 DB로 승격될 수 있음

![images/rds_aurora_elasticache/1.png](images/rds_aurora_elasticache/1.png)

## RDS 읽기복제본의 사용사례

- 프로덕션 데이터베이스가 사용되고 있을 때, 무언가의 이유로 데이터베이스에 대한 데이터 분석 및 레포팅이 필요한 상황
- 직접 메인 데이터베이스에 대한 분석을 수행하면 프로덕션 환경에 영향을 줄수 있으므로 읽기 복제본을 생성해서 그쪽에서 작업을 수행
- 프로덕션 환경은 영향을 받지 않고 분석 수행 가능
- 읽기복제본은 말 그대로 읽기만 수행 가능한 데이터베이스

![images/rds_aurora_elasticache/2.png](images/rds_aurora_elasticache/2.png)

## RDS 읽기복제본 네트워크 비용

- 기본적으로 같은 리전에서 발생하는 읽기복제에 대해서는 무료
- 다른 리전으로 읽기복제본을 생성해서 트래픽이 발생하는 것에 대해서는 과금

![images/rds_aurora_elasticache/3.png](images/rds_aurora_elasticache/3.png)

## RDS 복수 AZ 구성 (재난복구 DR)

- 동기식 복제
- 하나의 DNS 이름으로 장애시 다른 AZ의 인스턴스를 가리키도록 변경됨
- 가용성 증가
- AZ에 문제가 생겨서 사용 불가능해졌을때, 활용 가능
- 어플리케이션에서 무언가를 해야 하는것은 없음
- 확장으로 사용되지 않음 (대기본에 어떠한 작업을 수행할 수 없음)
- 읽기복제본 또한 복수 AZ로 구성 가능 (가용성 증가를 위해)

![images/rds_aurora_elasticache/4.png](images/rds_aurora_elasticache/4.png)

## RDS 단일 AZ에서 복수 AZ로 변경하는 방법

- 다운타임 발생하지 않음 (백그라운드 작업)
- 퍼포먼스에 영향 줄 수 있음 (복사작업에 의해 볼륨 사용량 증가)
- 백그라운드 상세
  - 스냅샷 작성
  - 새로운 AZ에서 DB 복구
  - 동기화 작업 시작으로 최종적으로는 동기화됨

![images/rds_aurora_elasticache/5.png](images/rds_aurora_elasticache/5.png)

## RDS Custom

- 오라클과 MSSQL 한정으로 백엔드 EC2에 직접 접근할수 있는 설정이 존재
- RDS는 모든것을 자동화하여 데이터베이스만 관리할 수 있도록 제공하나, 커스텀 설정을 통해 OS에 직접 접근 가능
- 오라클과 MSSQL 옵션에서 Deactivate Automation Mode를 선택하면, 지금까지 자동화되어 운영하는 방식에서 벗어나 직접 OS 권한을 가지게 됨

## Amazon Aurora

- 오로라는 AWS에 의해 최적화된 테크로 사양은 정확하게 공개되지 않음 (오픈소스가 아님)
- Postgres와 MySQL 호환 버전이 제공되며 기존 드라이버 그대로 접속 가능
- 오로라는 AWS 클라우드 최적화 모델로 MySQL에 비해 최대 5배 빠르고 Postgres보다는 최대 3배 빠름
- 오로라의 스토리지는 10GiB에서 최대 128TiB까지 자동으로 증가됨
- 오로라는 15개의 읽기복제본을 생성할 수 있음
  - 네이티브 MySQL이 5개까지 가능한 것에 비해 상당히 많음
  - 또한 기본적으로 복제 속도가 빠름 ~10ms
- 장애복구시 오로라는 중단없이 바로 이용가능하게 됨 (~30초)
- 오로라는 기본 DB에 비해 20%정도 비용이 비싸지만 더 효율적임

## Aurora 고가용성과 읽기분산

- 3개의 AZ에 6개의 데이터가 복사배치됨
  - 쓰기를 위해 최소 4개의 복사본이 필요
  - 읽기를 위해 최소 3개의 복사본이 필요
  - 데이터의 무결성이 항상 자동으로 복구됨 (데이터 파손시 즉시 복사)
  - 100개이상의 볼륨이 raid로 묶여 있음 (초고속)
- 하나의 오로라 인스턴스가 마스터 역할을 하여 쓰기 작업을 수행
- 장애시 30초 이내의 복구 수행
- 마스터는 최대 15개의 읽기복제본을 통해 읽기 분산 가능
- 리전간 읽기복제본 생성을 지원

![images/rds_aurora_elasticache/6.png](images/rds_aurora_elasticache/6.png)

## Aurora 데이터베이스 클러스터

![images/rds_aurora_elasticache/7.png](images/rds_aurora_elasticache/7.png)

- 엔드포인트 관리를 통해 인스턴스단위로 직접 접근할 필요가 없어짐
- 어플리케이션(클라이언트)에서는 쓰기/읽기를 위한 엔드포인트 주소만 알고 있으면 되고, AWS에서 어떤 인스턴스를 가리킬지는 알아서 처리해줌

## Aurora 읽기복제본 AS (Auto Scaling)

- 오로라는 쓰기용 엔드포인트와 읽기용 엔드포인트를 나눠서 제공함
- 읽기용 엔드포인트 밑에는 읽기복제본이 존재하는데, 읽기의 부하가 심해지면 자동으로 읽기복제본의 인스턴스를 증가시켜서 읽기 부하를 수평적 확장을 통해 대응함

![images/rds_aurora_elasticache/8.png](images/rds_aurora_elasticache/8.png)

## Aurora 읽기복제본 Custom Endpoints

- 읽기복제본 중 일부를 세트로 하여 커스텀 엔드포인트를 작성할 수 있음
- 예를 들어, 일부 읽기복제본의 인스턴스 크기를 더 큰것으로 설정하고, 커스텀 엔드포인트를 작성함
  - 이렇게 하는 이유는, 특정 분석용 쿼리를 주기적으로 실행해야 할 때, 해당 읽기복제본 세트를 이용하기 위함

![images/rds_aurora_elasticache/9.png](images/rds_aurora_elasticache/9.png)

## Aurora Serverless

- 예측 불가능한 부하로 인해 인스턴스의 크기를 결정하기 힘든 경우
- 초단위 작업이 일어나기 때문에, 인스턴스를 미리 선점하여 만들어 두고 싶지 않은 경우
- 사용한 만큼 과금이 되는 구조로 사용금액은 좀 더 비싸지만 내내 비용이 발생하지는 않으므로 사용 사례에 따라서는 유용하게 적용할 수 있음

![images/rds_aurora_elasticache/10.png](images/rds_aurora_elasticache/10.png)

## Aurora Multi-Master

- 일반적인 장애복구 시나리오는 마스터 1대가 장애를 겪을 경우 산재한 읽기복제본 중 하나를 마스터로 승격시켜 대체한 것인데, 이는 승격에 필요한 시간동안 마스터를 이용하지 못하게 됨
  - 오로라는 30초 이내의 승격시간을 가짐에도 불구하고 해당 시간동안에는 사용하지 못하는것은 맞음
- 이를 극복하기 위해 모든 노드에서 R/W가 가능하게 하고, 모든 데이터를 상호간에 복제하도록 하는 것이 다중 마스터 방식임
- 장애복구 다운타임이 발생하지 않는다는것이 장점
  - 단, 클라이언트에서도 동시에 여러개의 DB 커넥션을 관리하며, 장애시 다른 커넥션을 이용하여 그 즉시 대응할 수 있는 수단을 마련해야 함

![images/rds_aurora_elasticache/11.png](images/rds_aurora_elasticache/11.png)

## Global Aurora

- 오로라는 복수 리전에서의 읽기복제본을 지원
  - DR 대책으로 유용
  - 백그라운드 작업을 전부 오로라에서 대응하기 때문에 설정하는것 만으로 대응 가능
- 오로라 글로벌 데이터베이스 (이 방식이 추천됨)
  - 하나의 프라이머리 리전을 설정 (R/W)
  - 5개의 세컨더리 (R/O) 리전을 설정할수 있으며 레플리카 랙은 1초 미만임
  - 각각의 세컨더리 리전에서 최대 16개의 읽기복제본 설정 가능
  - 각각의 리전에서 데이터 읽기의 요구가 있는 경우 유용하게 활용 가능 (로컬 리전 읽기)
  - 프라이머리 리전에 장애가 생길 경우 세컨더리 리전을 프라이머리로 승격 가능한데 1분 이내에 작업이 완료되는 것이 목표로 설정되어 있음
  - 리전간 읽기복제는 1초 이내로 수행됨

## Aurora Machine Learning

- Aurora에서 머신러닝 베이스 예측을 쿼리를 통해 직접 수행할 수 있는 기능
- Aurora에 직접 연계된 AWS 머신러닝 (세이지메이커, 컴프리헨드 등) 기능을 통해 제공됨
- 쿼리를 직접 머신러닝과 연계하여 결과를 받아볼 수 있다는 점이 장점

![images/rds_aurora_elasticache/12.png](images/rds_aurora_elasticache/12.png)

## RDS 백업

- 자동 백업
  - 매일 풀백업이 작성됨 (유지보수 기간 중)
  - 트랜잭션 로그가 최대 5분간 저장됨
  - 5분내 원하는 시간대로 복원 가능
  - 풀백업은 1~35일간 저장 가능하고 설정에 의해 비활성화도 가능 (0으로 설정)
- 수동 DB 스냅샷
  - 유저에 의해 원하는 시간대에 백업 가능
  - 백업은 원하는 기간만큼 보존 가능
- RDS 데이터베이스는 중지시켜도 스토리지에 대한 과금과 더불어 7일뒤에는 자동으로 켜지게 되므로, 필요한 만큼만 사용하고 싶다면 사용 후에 스냅샷을 작성하고 데이터베이스를 삭제하는 전략을 사용해도 됨

## Aurora 백업

- 1~35일간 저장되는 백업 (비활성화 불가)
- 원하는 언제든 복원 가능
- 수동 DB 스냅샷
  - 유저에 의해 원하는 시간대에 백업 가능
  - 백업은 원하는 기간만큼 보존 가능

## RDS와 Aurora의 복원 옵션

- RDS와 오로라에서 복원을 하면 스냅샷으로부터 새로운 데이터베이스가 생성됨
- S3에서 복원하는 것도 가능
  - 온프레미스 데이터베이스가 있다면 백업을 생성할때 S3에 백업을 저장
  - 백업을 이용하여 복원할때 RDS의 데이터베이스 인스턴스로 복원하는 것이 가능
- MySQL 오로라 클러스터를 S3에서 복원하기
  - 백업을 Percona XtraBackup을 통해 S3에 백업
  - 백업 파일을 이용해서 새로운 오로라 클러스터로 복원

## Aurora 데이터베이스 클론

- 오로라 DB 클러스터의 클론을 만들 수 있음
- 스냅샷을 만들고 복원하는 것 보다 더 빠름
- 프로덕션 환경에 영향 없이 완전하게 동일한 내용으로 클론을 작성할 수 있음
- 사용 사례로서 스테이징 환경 등을 작성할때 사용 가능 (프로덕션에 영향 없이 새롭게 만들기 위함)

## RDS Aurora 보안

- 보존 자료 암호화
  - 마스터와 읽기복제본은 KMS 키를 통한 암호화가 지원됨 (데이터베이스 최초 시작 시 설정)
  - 마스터가 암호화되면 읽기복제본도 암호화되어야 함
  - 암호화되지 않은 데이터베이스는 스냅샷 후 복사 시 암호화를 통해 암호화 설정 가능
- 전송 중 암호화
  - TLS를 이용한 전송 중 암호화를 지원하며, AWS TLS 루트 인증서를 이용해 클라이언트 측에서 암호화 가능
- IAM 인증
  - EC2에 IAM 역할을 설정하여 데이터베이스에 유저명/비밀번호 없이 인증 가능
- 보안 그룹
  - RDS와 Aurora 데이터베이스 간의 방화벽 설정
- 언더라잉 인스턴스에 SSH 불가
  - RDS Custom (Oracle, MSSQL) 외에는 기본적으로 언더라잉 인스턴스에 접근 불가
- 감사 로그의 CloudWatch 로그 보존
  - 감사 로그 외 기타 로그들을 클라우드워치로 연계하여 저장 가능

## Amazon RDS Proxy

- RDS를 위한 관리형 데이터베이스 프록시
- DB 커넥션 수를 줄이기 위한 풀 내 앱들의 관리 등을 담당
- 데이터베이스 접속 자체에서 오는 오버헤드를 줄이는데 도움을 줌
- 서버리스로 자동 스케일링과 더불어 고가용성임 (다중 AZ 구성)
- RDS와 오로라의 장애시간을 최대 66% 감소시킴
- RDS의 MySQL PostgreSQL, MariaDB를 지원하고 오로라를 지원함
- 대부분의 앱에서 코드 변경사항은 없음
- IAM 인증을 강제로 적용시키며 AWS 시크릿 매니저를 통해 크레덴셜을 안전하게 보관함
- RDS 프록시는 외부 접근이 불가능하며 VPC내에서만 접근 가능

![images/rds_aurora_elasticache/13.png](images/rds_aurora_elasticache/13.png)

## Amazon ElastiCache 개요

- RDS가 DMBS의 관리형 버전인것과 같이
- ElastiCache는 Redis와 Memcached의 관리형 버전
- 캐시는 메모리 저장형 데이터베이스로 고성능, 저지연 데이터베이스
- 실제 데이터베이스의 부하를 줄이기 위해 존재 (읽기형 부하)
- 어플리케이션을 sateless 하게 만들어줌
- AWS는 Redis 및 Memcached가 존재하는 언더라잉 인스턴스를 관리해줌
- 엘라스티캐시를 사용하려면 어플리케이션에서 꽤 많은 코드 변경이 필요함

## ElastiCache 아키텍쳐 (DB 캐싱)

- 어플리케이션은 먼저 엘라스티캐시의 엔드포인트에 쿼리를 해 본뒤, 결과값이 존재하지 않는다면 RDS에 쿼리를 하는 방식으로 데이터를 처리해야 함
  - RDS에서 데이터를 가져올 경우 해당 데이터를 엘라스티캐시에 저장하는 후속작업 필요
- 이는 RDS에는 부하 감소로 이어짐
- 캐시에서 데이터를 가져왔을때 최신화된 데이터를 가져와야 하기 때문에, 캐시를 업데이트 하는 전략이 매우 중요하게 됨 (자칫하면 갱신되지 않은 데이터를 가져올 위험이 있음)

![images/rds_aurora_elasticache/14.png](images/rds_aurora_elasticache/14.png)

## ElastiCache 아키텍쳐 (유저 세션 저장소)

- 복수의 분산형 어플리케이션에서 로그인 발생시 세션을 엘라스티캐시에 저장
- 다른 어플리케이션에서 접근할때 캐시를 확인하여 세션이 남아있다면 유효한 로그인으로 확인되기 때문에 다시 로그인 해야 할 필요가 없음
- 분산형 시스템에서는 데이터베이스 세션 저장소를 많이 활용했는데, 이를 엘라스티캐시로 이전했다고 생각하면 됨

![images/rds_aurora_elasticache/15.png](images/rds_aurora_elasticache/15.png)

## ElastiCache Redis vs Memcached

- Redis는 다중 AZ의 장점
  - 장애복구, 읽기복제본 생성, 데이터 영속성, 백업과 복원 가능
- Memcached는 단일 AZ의 단점
  - 샤딩을 이용하여 고성능이지만 백업 및 복원 불가, 데이터 영속성 없음

![images/rds_aurora_elasticache/16.png](images/rds_aurora_elasticache/16.png)

## ElastiCache Cache Security

- ElastiCache에서 모든 캐시는
  - IAM 인증을 지원하지 않음
  - IAM 정책은 AWS API단계에서의 보안부분만을 지원
- Redis AUTH
  - 패스워드/토큰을 만들어서 레디스 클러스터에 적용 가능
  - 보안그룹도 물론 있지만 추가적으로 설정 가능함
  - SSL을 이용한 전송 중 암호화 가능
- Memcached
  - SASL 기반의 인증을 지원

![images/rds_aurora_elasticache/17.png](images/rds_aurora_elasticache/17.png)

## ElastiCache 패턴

- Lazy Loading
  - 모든 읽기 데이터는 캐시되며 읽어야 할 데이터는 캐시화됨
  - 즉, 읽기 단계에서 캐시 미스가 발생하면 그때 데이터를 업데이트 함
- Write Through
  - 데이터를 쓰거나 업데이트 하는 경우 캐시를 업데이트 함
  - 데이터를 읽기 전에 캐시를 업데이트 함
- Session Store
  - 캐시를 임시 세션 데이터 저장소로 활용함 (TTL 지표를 이용한 임시 저장)

![images/rds_aurora_elasticache/18.png](images/rds_aurora_elasticache/18.png)

## ElastiCache 사용사례

- 게이밍 리더보드 패턴
- Redis Sorted Set이 특정 엘리먼트의 유일성과 순서를 보장
- 새로운 엘리먼트가 추가될 경우 실시간으로 순위가 계산되어 적절한 순서로 재배열됨

![images/rds_aurora_elasticache/19.png](images/rds_aurora_elasticache/19.png)
