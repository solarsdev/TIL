# AWS X-Ray

- 프로덕션 환경에서의 디버깅으로 유용한것은
  - 로컬 테스트
  - 로깅 문구를 각 스텝별로 달아두기
  - 프로덕션환경을 다시 배포하기 등등
- 클라우드워치를 사용하면서 로그 포맷의 다양함은 분석에 애를 먹게 한다
- 디버깅은 모놀리식 서비스에서는 그나마 낫지만, 분산 환경에서는 어렵다
- 전체 아키텍쳐를 한눈에 볼수 있는 일반적인 솔루션이 없다

## X-Ray에서 보이는 비주얼 분석의 유용함

- 엑스레이는 각 서비스들을 시각화된 방식으로 투영할 수 있다
- 퍼포먼스를 개선할 수 있다 (보틀넥 감지)
- 마이크로서비스 아키텍쳐에서의 종속성을 이해 할 수 있음
- 핀포인트로 서비스 이슈를 캐치업 가능
- 현재 요청을 리뷰 가능
- 에러와 예외를 발견
- SLA의 준수 여부
- 어디에서 쓰로틀이 발생중인지 확인
- 유저들이 실제로 겪고 있는 영향치에 대한 식별

## 어떤 서비스들이 X-Ray를 지원하는가

- 람다
- 빈스토크
- ECS
- ELB
- API GateWay
- EC2 인스턴스 혹은 어떤 어플리케이션 서버라도 (온프레미스 포함)

## AWS X-Ray를 활용하면

- 트레이싱이란 요청을 따라가는 기술이다
- 각각의 요청을 처리하는 컴포넌트들은 고유한 트레이스(족적)을 남기게 된다
- 트레이싱은 세그먼트를 만든다 (또 그 하위 세그먼트)
- 에노테이션이 추가될수 있으며 이는 추가정보를 제공한다
- 트레이스의 기능
  - 모든 요청
  - 샘플 요청 (분당 비율 혹은 %)
- X-Ray의 보안
  - IAM 인증
  - 저장된 데이터에 대한 KMS 암호화

## X-Ray를 활성화 하는 방법

- 코드에 AWS X-Ray SDK를 심기
  - 최소한의 코드 수정
  - SDK는 다음과 같은 정보를 수집
    - AWS 서비스 요청
    - HTTPS HTTP 요청
    - 데이터베이스 요청 (MySQL, PostgreSQL, DynamoDB)
    - 큐 요청 (SQS)
- X-Ray데몬을 설치 혹은 X-Ray AWS 통합을 활성화
  - X-Ray 데몬은 저계층의 UDP 인터셉터로 동작 (Linux Windows Mac...)
  - AWS 람다 혹은 다른 AWS 서비스는 이미 X-Ray 데몬을 돌리고 있음
  - 각각의 어플리케이션은 올바른 IAM 권한이 활성화 되어 있어야 함 (X-Ray 전용 권한)

## X-Ray 문제해결

- x-ray가 동작하지 않을때 (EC2)
  - EC2 IAM 역할에 권한부여가 제대로 되어 있는지
  - EC2 인스턴스에 X-Ray 데몬이 설치되어 있는지
- 람다에서 활성화 방법
  - IAM 실행 권한이 붙어있어야 함 (AWSX-RayWriteOnlyAccess)
  - X-Ray SDK 코드가 포함되어 있는지
