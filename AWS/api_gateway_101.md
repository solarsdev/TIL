# API Gateway 101

![images/api_gateway_101/1.png](images/api_gateway_101/1.png)

- AWS 람다 + API Gateway: 관리할 인프라가 없음
- WebSocket프로토콜을 지원함
- API 버저닝을 지원 (v1, v2...)
- 서로 다른 환경을 지원 (dev, test, prod ...)
- 보안을 담보 (인증과 승인)
- API키를 만들고 요청 쓰로틀링 설정이 가능
- Swagger Open API를 위한 API 정의가 가능
- 요청을 변환, 검증하고 응답함
- SDK를 만들고 API 상세 도큐멘트를 작성해줌
- API 캐시 응답을 지원

## API 게이트웨이 통합

- 람다함수
  - 람다함수의 호출
  - REST API를 노출하는 가장 일반적이고 쉬운 방법
- HTTP
  - 백엔드의 HTTP엔드포인트를 노출시킴
  - 예) 내부 HTTP API, ALB 등
  - 왜 굳이 API게이트웨이를? → 요청 비율의 제한, 캐싱, 유저 인증, API키 등을 활용하기 위함
- AWS서비스들
  - 어떤 AWS 서비스와도 통합이 가능하다
  - 예) AWS 스텝 펑션을 이용한 워크플로우, SQS에 포스트 메시지 작성 등
  - 왜 이때 API게이트웨이를? → 인증, 배포, 요청 비율 제한 등

## Endpoint 타입

- Edge-Optimized (기본) : 글로벌 클라이언트
  - 클라우드프론트의 엣지 로케이션을 이용하여 해당 장소에 API를 배포 (지연속도 감소를 위해)
  - API게이트웨이는 하나의 리전 베이스로 가동됨
- 리저널
  - 같은 리전에 있는 유저들에게 제공하는 경우
  - 클라우드프론트를 수동으로 런칭시킨 뒤 매칭시켜 캐싱 전략이나 배포 전략에 좀 더 세밀한 컨트롤이 가능
- 프라이빗
  - 같은 VPC내부에서만 접근이 가능하도록 설정 VPC 엔드포인트 (ENI) 를 사용하게 된다
  - 접근제한을 위해 리소스 정책을 이용한다

## 배포 스테이지

- API Gateway를 변경해도 즉시 효과가 발생하는 것은 아니다
- 배포 작업을 통해서 변화된 내용을 반영할 수 있다
- 주로 이러한 내용을 몰라서 혼동할때가 많다
- 변경점은 다양한 스테이지에 배포가능하다 (그리고 스테이지는 원하는 만큼 만들 수 있음)

![images/api_gateway_101/2.png](images/api_gateway_101/2.png)

- 스테이지에는 이름을 붙일 수 있다 (dev, test, prod 등등)
- 각각의 스테이지는 고유한 설정 변수를 가진다
  - 스테이지 변수는 API 게이트웨이를 위한 환경 변수로 이해하자
  - 환경 내에서 자주 변경되는 일부의 설정이 있다면 그때 이용 가능하다
  - 예를 들면
    - 람다 함수의 ARN
    - HTTP 엔드포인트 주소
    - 패러미터
  - 유스케이스로서
    - HTTP 엔드포인트를 설정 (dev, test, prod..)
    - 맵핑 템플릿을 이용하여 람다 함수에 설정 변수를 전달
  - 스테이지 변수는 람다 함수에 context 오브젝트로 전달된다
    ![images/api_gateway_101/3.png](images/api_gateway_101/3.png)
- 스테이지는 배포 이력에 따라 롤백이 가능하다

## 카나리 배포

- 어떤 스테이지에서도 카나리 배포를 이용할 수 있지만 일반적으로는 PROD 환경이 많음
- 일정 비율의 요청을 카나리 채널로 받는것을 의미
  ![images/api_gateway_101/4.png](images/api_gateway_101/4.png)
- 지표와 로그가 분리됨 (모니터링이 편리해짐)
- 스테이지 변수를 카나리를 위해 분리 가능
- 블루 그린 배포 전략 (람다와 API 게이트웨이를 이용한)

## 통합 타입

- 통합 타입 MOCK
  - API Gateway는 백엔드로 데이터를 송신하지 않고 바로 응답을 보내줌
- 통합 타입 HTTP / AWS (Lambda & AWS Services)
  - 통합 요청과 응답을 양쪽 다 설정해야함
  - 맵핑 템플릿을 이용해서 요청과 응답 양쪽에 데이터 맵핑 가능
- 통합 타입 AWS_PROXY
  - 클라이언트에서 들어오는 요청이 그대로 람다의 인풋으로 전달됨
  - 함수에서 응답해야 할 책임이 있음
  - 맵핑 템플릿이나 헤더, 쿼리 스트링은 전부 매개변수로 전달됨
- 통합 타입 HTTP_PROXY
  - 맵핑 템플릿은 없음
  - HTTP요청이 그대로 백엔드로 전달됨
  - HTTP응답은 API Gateway를 통해 전달됨

## 맵핑 템플릿

- 맵핑 템플릿은 요청과 응답을 수정할 수 있는 기능
- 쿼리 스트링 매개변수의 이름이나 값을 변경할 수 있음
- body content를 수정 가능
- 헤더를 추가 가능
- VTL(Velocity Template Language)를 이용해서 for loop, if 등 스크립트를 작성하면 됨
- 결과를 필터링 아웃 할 수 있음 (필요없는 데이터는 삭제)
- 예
  - SOAP API는 XML기반인데, REST API는 JSON 기반
    ![images/api_gateway_101/5.png](images/api_gateway_101/5.png)
  - 이 경우에 API Gateway에서는
    - 유저로부터의 요청에 데이터를 가공 (경로, 페이로드, 헤더를 추가)
    - 요청 데이터에 기반하여 SOAP 메시지를 만들어 넘김
    - SOAP 서비스를 요청하고 XML 응답을 받아냄
    - XML 응답을 JSON으로 변경하여 클라이언트에게 응답
- 또 다른 예

![images/api_gateway_101/6.png](images/api_gateway_101/6.png)
