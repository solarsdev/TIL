# SQS (Simple Queue Service)

![images/sqs/1.png](images/sqs/1.png)

- AWS에서 가장 오래된 서비스 중 하나 (10년 이상)
- 완전 관리형 서비스이며, 어플리케이션의 디커플링에 이용된다.
- 속성
  - 처리량이 무제한이며, 큐에 들어오는 메시지의 숫자 또한 무제한이다.
  - 메시지의 보존기간이 제한되어 있으며, 4일~최대 14일까지 체류 가능하다.
  - 지연시간이 낮다. (퍼블리싱과 리시빙에 <10ms 정도의 시간이 소요됨)
  - 메시지당 256KB의 제한이 있다.
- 중복된 메시지를 허용한다. (최소한 한번은 전달된다. 때때로)
- 순서에 상관없는 메시지를 허용한다. (그렇지만 최대한 순서를 맞추려고 노력하는 모델)

## 메시지 제공자

![images/sqs/2.png](images/sqs/2.png)

- SenMessage API를 이용해서 SQS에 정보를 제공
- 소비자가 삭제하기 전까지 메시지는 계속 존재한다.
- 메시지 보존기간: 4일에서 14일까지
- 예를 들어: 주문 처리 메시지라면
  - Order id
  - Customer id
  - 추가로 어떤 정보도 가능
- SQS 스탠다드: 무제한 처리량을 지원

## 메시지 소비자

- 소비자란: EC2 인스턴스에서 돌아가는 서비스, 온프레미스, 람다 등등
- SQS에서 메시지를 가져온다. (한번에 10개의 메시지까지 가져올 수 있음)

![images/sqs/3.png](images/sqs/3.png)

- 메시지를 처리한다. (예를 들면, RDS 데이터베이스에 해당 메시지를 저장한다거나)
- 메시지가 처리되면 다른 소비자가 보지 못하도록 메시지를 큐에서 삭제한다. (DeleteMessage API)

## 동시 소비자 개념

![images/sqs/4.png](images/sqs/4.png)

- 소비자는 메시지를 병렬로 받고, 처리한다.
- 최소한 1번은 메시지를 받는다. (중복 메시지 수신의 가능성이 있음)
- 메시지 순서는 폴링 순서에 따라 최대한 지켜진다. (중복 메시지 수신의 가능성 때문에 Best Effort)
- 소비자는 메시지를 처리한 뒤에 삭제한다.
- 소비자를 병렬로 스케일링 해서 처리량을 극대화 할 수 있다.
- ASG를 이용한 SQS
  - ASG를 SQS와 연계하여
  - Queue Lenth가 증가할 경우, 클라우드워치 알람을 통해 ASG의 인스턴스를 늘리는것이 가능함
    ![images/sqs/5.png](images/sqs/5.png)

## 어플리케이션 티어를 디커플링하기

- 프론트엔드의 웹앱이 규모가 클 경우, 백엔드의 비디오 프로세싱 앱에 한번에 과도한 메시지가 몰릴 수 있다
- 병목현상을 해결하기 위해 두 앱 사이에 SQS를 두고 폴링처리를 이용해서 비디오 프로세싱이 처리할 수 있는 최대치를 견딜 수 있도록 완충작용을 할 수 있다

![images/sqs/6.png](images/sqs/6.png)

## SQS의 보안

- 암호화
  - 전송시 암호화 구현: HTTPS API를 이용
  - 보존자료 암호화 구현: KMS 키를 이용한 암호화
  - 클라이언트측 암호화: 클라이언트에서 암호화 및 복호화를 직접 처리 가능
- 접근 제어: IAM 권한을 이용해서 SQS API의 접근제어 가능
- SQS Access 정책 (S3의 버킷 정책과 비슷)
  - 크로스 어카운트 접근시 유용하게 활용 가능
  - 다른 서비스들이 SQS에 접근하기 위한 정책으로 제어 가능

## SQS 설정시 옵션

- FIFO, Standard
- 메시지 사이즈
- 메시지 보존 기간
- 엑세스 정책
  - 다른 AWS 계정
- 암호화
  - 전송시 암호화는 기본 ON
  - CMK (customer master key from KMS)

## SQS 메시지 전송 및 폴링

- 메시지 전송은 아무때나 원하는만큼 가능
- 폴링시에는 정해진 폴링시간동안 메시지를 가져오고, 제한시간내에 메시지를 처리하지 못하면 다시 메시지가 보내진다.
- 메시지 큐를 퍼징할수 있음 (전부 삭제)

## SQS 큐 엑세스 정책

- 유스케이스 2가지
- 다른 AWS 계정에서 접근
  - SQS 큐는 접근제한 정책을 설정함으로써 다른 AWS 계정에서 접근하는것을 허용할 수 있다.
    ![images/sqs/7.png](images/sqs/7.png)
- S3 이벤트 알림을 통해 SQS 큐에 저장하기
  - S3에게 SQS 접근권한을 줌으로써, S3가 직접 SQS에 메시지를 전송할 수 있도록 한다.
    ![images/sqs/8.png](images/sqs/8.png)
- send message와 recieve메시지 양쪽에 독립적인 권한 설정 가능
- S3 설정 예
  - S3에서 Event 설정 후 put object 이벤트를 걸어둠
  - SQS큐를 목적지로 설정하고 저장할때 그냥 저장하면 에러가 남
  - SQS큐에서 미리 S3 ARN을 허용해놓고 설정해야 함
